

Webs =
  init: ->
    try
      <% if Pusher.host %>
        Pusher.host = '<%= Pusher.host %>';
        Pusher.wss_port = '443';
      <% end %>
      @pusher = new Pusher('<%= Pusher.key %>')
      @pusher.subscribe "moci", (data) ->
        Moci.debug("Got data: " + JSON.stringify(data))

  subscribe: (channel_name) ->
    channel = @pusher.subscribe channel_name if @pusher
    channel.bind_all(Webs.receive)

  receive: (data) ->
    Moci.debug("Got project data: " + JSON.stringify(data))
    d = data['data']
    switch data['event']
      when 'test_suite_run'
        if $('.last_runs .test_suite_run_'+d['id']).length == 0
          q = $.ajax
            url: '/projects/tr_last_run?'+$.param({project_name: Project.name, test_suite_run_id: d['id']})
            dataType: 'html'
            async: false
            success: (d,t,j) ->
              $(d).prependTo('.last_runs')
        else
          tr = $('.last_runs .test_suite_run_'+d['id'])
          tr.find('td.state').html(d['state'])
          tr.removeClass('state_running')
          tr.removeClass('state_finished')
          tr.addClass('state_'+d['state'])
       when 'test_unit_run'
         tsr_id = d['test_suite_run']['id']
         tr_details = $('.last_runs .details.test_suite_run_'+tsr_id)
         if tr_details.length != 0
           tr_details.show()
           tr_details.find('.current_test_unit').html(d['test_unit']['class_name'] + ' :: ' + d['test_unit']['name'])
           tr_details.removeClass('tu_state_waiting')
           tr_details.removeClass('tu_state_ok')
           tr_details.removeClass('tu_state_fail')
           switch d['result']
             when 'W'
                tr_details.addClass('tu_state_waiting')
             when 'E', 'F'
                tr_details.addClass('tu_state_fail')
             when '.'
                tr_details.addClass('tu_state_ok')
         else
    if $('.last_runs tr.state_finished').length > 16
      $('.last_runs tr.state_finished').slice(-6).remove()

Project = {}

LastTestSuiteRuns =
  update_progress: ->
    $('.last_runs tr.state_running .info .progress').each (index) ->
      now_time = new Date().getTime() / 1000
      creation_time = parseInt($(this).parents('tr').attr('data-created-at'))
      total = $(this).parents('tr').attr('data-time-est')
      run_time = now_time - creation_time
      if run_time > total
        percentage = 100
      else
        percentage = Math.round((run_time / total)*100)
      $(this).progressbar({value: percentage})


$(document).ready ->

  Webs.init()

  if $('h1.project').length != 0
    Project.id = $('h1.project').attr('data-project-id')
    Project.name = $('h1.project').attr('data-project-name')
    channel = 'moci_project_' + Project.id
    Moci.debug("Subscribing to project channel " + channel)
    Webs.subscribe(channel)
    setInterval LastTestSuiteRuns.update_progress, 500




